{% extends "main/base.html" %}
{% block title %}Al-Iman | My Students{% endblock %}
{% block content %}
{% comment %} <h1>{{ subject.name }}</h1> {% endcomment %}
<h1>Teacher: {{ subject.teacher_name }}</h1>
<h2>Subject/Class: {{ subject.subject_name }} {{ subject.subject_class }}</h2>
<form action='/test/' method='POST'>
    <input type='button' onclick='edit()' id='edit-btn' class='btn btn-primary' value='Edit'/>
<table class='table'>
    <thead>
        <th>Student name</th>
        <th>Subject name</th>
        <th>First CA</th>
        <th>Second CA</th>
        <th>Third CA</th>
        <th>Exams</th>
        <th>Total</th>
    </thead>
    <tbody>
            {% for CA in continousassessment %}
                <tr data-id='{{ CA.id }}'>
                    <td>{{ CA.student.get_full_name }}</td>
                    <td>{{ CA.subject.subject_name }}</td>
                    <td class='scores' contenteditable="false" onblur="handleInput(this)">{{ CA.first_ca }}</td>
                    <td class='scores' contenteditable="false" onblur="handleInput(this)">{{ CA.second_ca }}</td>
                    <td class='scores' contenteditable="false" onblur="handleInput(this)">{{ CA.third_ca }}</td>
                    <td class='scores' contenteditable="false" onblur="handleInput(this)">{{ CA.exams }}</td>
                    <td contenteditable="false" oninput="handleInput(this)">{{ CA.total }}</td>
                </tr>
            {% endfor %}
    </tbody>
</table>
<button type="submit" onclick='hello()' class="btn btn-primary">Save</button>
</form>
<script>
    function edited_data(){
        console.log("Hello!");
        datas = []
        rows = document.querySelectorAll('tr');

        rows.forEach(row => {
            id = row.dataset.id;
            first_ca = pass;
            datas.push(row)
        })
    }
    function edit(){
        const cells = document.querySelectorAll(".scores");
        cells.forEach(function(cell) {
            cell.contentEditable=true});
    }
    const edit_btn = document.getElementById("edit-btn");
    edit_btn.onclick = edit;

    function handleInput(cell) {
        // Handle the input event here
        console.log("Content changed:", cell.innerText);

        // Send the updated content to the backend view
        // check if the content is integer
        value = +cell.innerText;
        isValid = !isNaN(value);
        
        if (isValid) {
            sendDataToBackend(cell.innerText, cell);
            cell.style.backgroundColor = 'white';
            cell.style.color = 'black';
            // will later refactor this to enable toggling of the bg.
        } else {
            console.log(`Invalid value assigned to cell.innerText ${cell.innerText}`);
            cell.style.backgroundColor = 'red';
            cell.style.color = 'white';
        }
    }

    function sendDataToBackend(updatedContent, value) {
        // Create an XMLHttpRequest object
        var xhr = new XMLHttpRequest();

        // Configure it to send a POST request to your Django backend view
        xhr.open('POST', '/test/', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Define the data to be sent
        var data = 'updated_content=' + encodeURIComponent(updatedContent);
        console.log(`cell : ${value}`);

        // Set up the callback function to handle the response from the server
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Handle the response from the server if needed
                console.log('Server response:', xhr.responseText);
            }
        };

        // Send the data to the server
        xhr.send(data);
    }
</script>
{% endblock %}